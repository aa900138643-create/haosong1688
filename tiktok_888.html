<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVIP å¾Œå°ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        body { background-color: #111; color: #fff; font-family: 'Segoe UI', sans-serif; }
        [v-cloak] { display: none !important; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .snap-x { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, 20px); } to { opacity: 1; transform: translate(-50%, 0); } }
        .toast-anim { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-[#111] text-white min-h-screen pb-20">

    <div id="app" v-cloak>
        <header class="fixed top-0 w-full z-40 bg-black/80 backdrop-blur-md border-b border-gray-800 p-4 flex justify-center items-center h-16">
            <h1 class="text-xl font-bold text-red-500 tracking-widest">å¾Œå°ç®¡ç†æ¨¡å¼</h1>
        </header>

        <main class="pt-20 px-4 max-w-lg mx-auto">
            
            <div v-if="!user" class="py-10 text-center space-y-4 bg-[#1a1a1a] p-6 rounded-xl border border-gray-700 shadow-2xl">
                <h2 class="text-2xl font-bold text-white mb-6">ç®¡ç†å“¡ç™»å…¥</h2>
                
                <input v-model="loginForm.email" type="email" class="w-full bg-black border border-gray-700 rounded p-3 text-white" placeholder="Email">
                <input v-model="loginForm.password" type="password" class="w-full bg-black border border-gray-700 rounded p-3 text-white" placeholder="å¯†ç¢¼">
                
                <div class="flex gap-2">
                    <input v-model="loginForm.captcha" type="text" class="w-1/2 bg-black border border-gray-700 rounded p-3 text-white uppercase" placeholder="é©—è­‰ç¢¼">
                    <canvas id="captchaCanvas" width="120" height="50" class="bg-gray-800 rounded cursor-pointer border border-gray-600 hover:border-yellow-500" @click="generateCaptcha" title="é»æ“Šæ›´æ›"></canvas>
                </div>

                <button @click="login" class="w-full bg-yellow-600 hover:bg-yellow-500 text-white font-bold py-3 rounded transition mt-4">
                    ç™»å…¥ç³»çµ±
                </button>
                <p class="text-xs text-gray-500 mt-4">é—œé–‰ç¶²é å³è‡ªå‹•ç™»å‡º</p>
            </div>

            <div v-else>
                <div class="flex justify-between items-center mb-6 bg-gray-900 p-4 rounded-lg border border-gray-700">
                    <h2 class="text-xl font-bold text-white">æ­¡è¿å›ä¾†</h2>
                    <button @click="logout" class="text-xs text-red-400 border border-red-900 px-3 py-1.5 rounded hover:bg-red-900 transition">ç™»å‡º</button>
                </div>

                <div class="flex gap-2 mb-6 border-b border-gray-700 pb-2">
                    <button @click="adminTab = 'product'" :class="adminTab === 'product' ? 'text-yellow-500 border-b-2 border-yellow-500' : 'text-gray-400'" class="pb-2 px-2 font-bold transition flex-1">ğŸ“¦ å•†å“ç®¡ç†</button>
                    <button @click="adminTab = 'layout'" :class="adminTab === 'layout' ? 'text-yellow-500 border-b-2 border-yellow-500' : 'text-gray-400'" class="pb-2 px-2 font-bold transition flex-1">ğŸ¨ ç¶²ç«™ä½ˆç½®</button>
                </div>

                <div v-if="adminTab === 'product'" class="space-y-4 animate-fadeIn">
                    <div class="bg-black/50 p-4 rounded border border-gray-800 relative">
                        <h3 class="text-sm font-bold text-gray-300 mb-3">
                            <span v-if="isEditing" class="text-green-400">âœï¸ æ­£åœ¨ç·¨è¼¯: {{ form.name }}</span>
                            <span v-else>æ–°å¢å•†å“</span>
                        </h3>
                        <button v-if="isEditing" @click="cancelEdit" class="absolute top-4 right-4 text-xs bg-gray-700 px-2 py-1 rounded">å–æ¶ˆç·¨è¼¯</button>

                        <div class="space-y-3">
                            <div class="flex items-center gap-2 bg-gray-900/50 p-2 rounded border border-gray-700">
                                <input v-model="form.isTop" type="checkbox" id="isTop" class="w-4 h-4 text-yellow-500 rounded focus:ring-yellow-500 border-gray-300 cursor-pointer">
                                <label for="isTop" class="text-sm font-bold text-yellow-500 cursor-pointer flex items-center gap-1">
                                    <i class="fas fa-fire"></i> è¨­å®šç‚ºç½®é ‚ç†±é–€å•†å“
                                </label>
                            </div>

                            <input v-model="form.name" type="text" class="w-full bg-black border border-gray-700 rounded p-2 text-white text-sm" placeholder="åå­—">
                            <div class="grid grid-cols-2 gap-2">
                                <input v-model="form.price" type="number" class="w-full bg-black border border-gray-700 rounded p-2 text-white text-sm" placeholder="åƒ¹æ ¼">
                                <input v-model="form.tags" type="text" class="w-full bg-black border border-gray-700 rounded p-2 text-white text-sm" placeholder="æ¨™ç±¤">
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <input v-model="form.height" type="text" class="w-full bg-black border border-gray-700 rounded p-2 text-white text-sm" placeholder="èº«é«˜">
                                <input v-model="form.weight" type="text" class="w-full bg-black border border-gray-700 rounded p-2 text-white text-sm" placeholder="é«”é‡">
                                <input v-model="form.cup" type="text" class="w-full bg-black border border-gray-700 rounded p-2 text-white text-sm" placeholder="ç½©æ¯">
                            </div>
                            <textarea v-model="form.imagesText" rows="3" class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-green-400 font-mono" placeholder="åœ–ç‰‡é€£çµ (ä¸€è¡Œä¸€å¼µ)"></textarea>
                            <textarea v-model="form.details" rows="3" class="w-full bg-black border border-gray-700 rounded p-2 text-white text-sm" placeholder="è©³ç´°ä»‹ç´¹"></textarea>
                            
                            <button @click="saveProduct" 
                                    :class="isEditing ? 'bg-green-600 hover:bg-green-500' : 'bg-blue-600 hover:bg-blue-500'"
                                    class="w-full text-white font-bold py-2 rounded text-sm transition">
                                <i class="fas" :class="isEditing ? 'fa-save' : 'fa-plus'"></i> 
                                {{ isEditing ? 'å„²å­˜ä¿®æ”¹' : 'æ–°å¢å•†å“' }}
                            </button>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h3 class="text-xs font-bold text-gray-500 mb-2 uppercase">ç¾æœ‰å•†å“ ({{ products.length }})</h3>
                        <div class="space-y-2 max-h-[500px] overflow-y-auto pr-1">
                            <div v-for="p in products" :key="p.id" class="flex justify-between items-center bg-black p-2 rounded border border-gray-800 hover:border-gray-600 transition" :class="p.isTop ? 'border-l-4 border-l-yellow-500' : ''">
                                <div class="flex items-center gap-2 w-2/3">
                                    <i v-if="p.isTop" class="fas fa-fire text-yellow-500 text-xs"></i>
                                    <img :src="ensureArray(p.images)[0]" class="w-8 h-8 rounded object-cover flex-shrink-0">
                                    <span class="text-sm truncate" :class="p.isTop ? 'text-yellow-500 font-bold' : ''">{{ p.name }}</span>
                                </div>
                                <div class="flex gap-2">
                                    <button @click="openEdit(p)" class="text-xs bg-gray-800 text-yellow-500 px-2 py-1 rounded hover:bg-gray-700 border border-gray-700">ç·¨è¼¯</button>
                                    <button @click="deleteProduct(p.id)" class="text-xs bg-red-900/30 text-red-400 px-2 py-1 rounded hover:bg-red-900">åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div v-if="adminTab === 'layout'" class="space-y-4 animate-fadeIn">
                    <div class="bg-black/50 p-4 rounded border border-gray-800">
                        <label class="block text-xs font-bold text-yellow-500 mb-2">ğŸ“¢ è·‘é¦¬ç‡ˆå…¬å‘Šæ–‡å­—</label>
                        <input v-model="layoutForm.announcement" type="text" class="w-full bg-black border border-gray-700 rounded p-2 text-white text-sm">
                    </div>
                    <div class="bg-black/50 p-4 rounded border border-gray-800">
                        <label class="block text-xs font-bold text-yellow-500 mb-2">ğŸ–¼ï¸ é¦–é å¤§åœ–è¼ªæ’­</label>
                        <p class="text-[10px] text-gray-500 mb-1">ä¸€è¡Œä¸€å¼µ Imgur é€£çµã€‚</p>
                        <textarea v-model="layoutForm.bannersText" rows="6" class="w-full bg-black border border-gray-700 rounded p-2 text-xs text-green-400 font-mono"></textarea>
                    </div>
                    <button @click="saveLayoutSettings" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded text-sm transition shadow-lg">
                        <i class="fas fa-save mr-1"></i> å„²å­˜è¨­å®š
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        // âš ï¸ å¼•å…¥ setPersistence å’Œ browserSessionPersistence (é€™æ˜¯é—œéµï¼)
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, query, orderBy, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { createApp, ref, onMounted, nextTick } from "https://unpkg.com/vue@3/dist/vue.esm-browser.js";

        // ==========================================
        // âš ï¸ ä½ çš„ Firebase Config (å·²å¡«å¥½)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyAps3bNHrLZCmwCG3am2RZkyQmSmY_PmRo",
            authDomain: "haosong168-a6bfa.firebaseapp.com",
            projectId: "haosong168-a6bfa",
            storageBucket: "haosong168-a6bfa.firebasestorage.app",
            messagingSenderId: "633968472102",
            appId: "1:633968472102:web:410d466ce7c88a644636e7",
            measurementId: "G-M7H8ZDV93Q"
        };

        createApp({
            setup() {
                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);
                const auth = getAuth(app); 

                const products = ref([]);
                const layout = ref({});
                const adminTab = ref('product');
                
                // ç™»å…¥ç›¸é—œ
                const user = ref(null);
                const loginForm = ref({ email: '', password: '', captcha: '' });
                const generatedCode = ref(''); // å„²å­˜æ­£ç¢ºçš„é©—è­‰ç¢¼

                // å•†å“è¡¨å–®
                const form = ref({ name: '', price: '', tags: '', height: '', weight: '', cup: '', imagesText: '', details: '', isTop: false });
                const layoutForm = ref({ bannersText: '', announcement: '' });
                const isEditing = ref(false);
                const editingId = ref(null);

                // === é©—è­‰ç¢¼ç”Ÿæˆé‚è¼¯ ===
                const generateCaptcha = () => {
                    const canvas = document.getElementById('captchaCanvas');
                    if (!canvas) return;
                    const ctx = canvas.getContext('2d');
                    
                    ctx.clearRect(0, 0, 120, 50);
                    ctx.fillStyle = '#222';
                    ctx.fillRect(0, 0, 120, 50);

                    const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; 
                    let code = '';
                    for (let i = 0; i < 4; i++) {
                        code += chars.charAt(Math.floor(Math.random() * chars.length));
                    }
                    generatedCode.value = code;

                    ctx.font = 'bold 30px Arial';
                    ctx.textBaseline = 'middle';
                    for (let i = 0; i < 4; i++) {
                        ctx.fillStyle = `hsl(${Math.random() * 360}, 70%, 70%)`; 
                        ctx.save();
                        ctx.translate(20 + i * 25, 25);
                        ctx.rotate((Math.random() - 0.5) * 0.4); 
                        ctx.fillText(code[i], 0, 0);
                        ctx.restore();
                    }

                    for (let i = 0; i < 5; i++) {
                        ctx.strokeStyle = `rgba(255, 255, 255, 0.2)`;
                        ctx.beginPath();
                        ctx.moveTo(Math.random() * 120, Math.random() * 50);
                        ctx.lineTo(Math.random() * 120, Math.random() * 50);
                        ctx.stroke();
                    }
                };

                onMounted(() => {
                    onAuthStateChanged(auth, (currentUser) => {
                        user.value = currentUser;
                        if (!currentUser) {
                            nextTick(() => generateCaptcha());
                        }
                    });

                    // è®€å–å•†å“ (å«ç½®é ‚æ’åº)
                    const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
                    onSnapshot(q, (snapshot) => {
                        const rawProducts = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        products.value = rawProducts.sort((a, b) => {
                            const topA = a.isTop ? 1 : 0;
                            const topB = b.isTop ? 1 : 0;
                            if (topA !== topB) return topB - topA;
                            return 0;
                        });
                    });
                    
                    fetchLayoutSettings();
                });

                const login = async () => {
                    // 1. å…ˆæª¢æŸ¥é©—è­‰ç¢¼
                    if (loginForm.value.captcha.toUpperCase() !== generatedCode.value) {
                        alert("âŒ é©—è­‰ç¢¼éŒ¯èª¤ï¼Œè«‹é‡æ–°è¼¸å…¥ï¼");
                        loginForm.value.captcha = '';
                        generateCaptcha(); 
                        return;
                    }

                    // 2. é€²è¡Œç™»å…¥ (è¨­å®šç‚º Session æŒä¹…æ€§ï¼Œé—œé–‰ç¶²é å³ç™»å‡º)
                    try {
                        // âš ï¸ é—œéµï¼šè¨­å®š Persistence ç‚º Session (è¦–çª—é—œé–‰å³æ¸…é™¤)
                        await setPersistence(auth, browserSessionPersistence);
                        
                        await signInWithEmailAndPassword(auth, loginForm.value.email, loginForm.value.password);
                        alert("ç™»å…¥æˆåŠŸï¼");
                    } catch (error) {
                        alert("ç™»å…¥å¤±æ•—ï¼š" + error.message);
                        generateCaptcha(); 
                    }
                };

                const logout = async () => {
                    await signOut(auth);
                    alert("å·²ç™»å‡º");
                    cancelEdit();
                    nextTick(() => generateCaptcha());
                };

                const fetchLayoutSettings = async () => {
                    try {
                        const docRef = doc(db, "settings", "global");
                        const docSnap = await getDoc(docRef);
                        if (docSnap.exists()) {
                            layout.value = docSnap.data();
                            layoutForm.value.announcement = layout.value.announcement || '';
                            layoutForm.value.bannersText = (layout.value.banners || []).join('\n');
                        }
                    } catch (e) { console.log("No Settings"); }
                };

                const saveLayoutSettings = async () => {
                    if (!user.value) return alert("è«‹å…ˆç™»å…¥ï¼");
                    const bannersArray = layoutForm.value.bannersText.split('\n').map(l => l.trim()).filter(l => l.length > 0);
                    try {
                        await setDoc(doc(db, "settings", "global"), { announcement: layoutForm.value.announcement, banners: bannersArray });
                        layout.value = { announcement: layoutForm.value.announcement, banners: bannersArray };
                        alert("å·²å„²å­˜ï¼");
                    } catch (e) { alert("å„²å­˜å¤±æ•—: " + e.message); }
                };

                const ensureArray = (imgs) => Array.isArray(imgs) ? imgs : (imgs ? [imgs] : ['https://placehold.co/600x800']);
                
                const openEdit = (item) => {
                    isEditing.value = true;
                    editingId.value = item.id;
                    form.value = {
                        name: item.name,
                        price: item.price,
                        tags: item.tags,
                        height: item.height || '',
                        weight: item.weight || '',
                        cup: item.cup || '',
                        details: item.details || '',
                        isTop: item.isTop || false,
                        imagesText: ensureArray(item.images).join('\n')
                    };
                };

                const cancelEdit = () => {
                    isEditing.value = false;
                    editingId.value = null;
                    form.value = { name: '', price: '', tags: '', height: '', weight: '', cup: '', imagesText: '', details: '', isTop: false };
                };

                const saveProduct = async () => {
                    if (!user.value) return alert("è«‹å…ˆç™»å…¥ï¼");
                    if (!form.value.name || !form.value.price) return alert("è«‹å¡«å¯«è³‡æ–™");
                    
                    const imgs = form.value.imagesText.split('\n').map(l => l.trim()).filter(l => l);
                    const productData = {
                        name: form.value.name,
                        price: form.value.price,
                        tags: form.value.tags,
                        height: form.value.height,
                        weight: form.value.weight,
                        cup: form.value.cup,
                        details: form.value.details,
                        isTop: form.value.isTop || false,
                        images: imgs.length ? imgs : ['https://placehold.co/600x800']
                    };

                    try {
                        if (isEditing.value && editingId.value) {
                            await updateDoc(doc(db, "products", editingId.value), productData);
                            alert("æ›´æ–°æˆåŠŸï¼");
                            cancelEdit();
                        } else {
                            await addDoc(collection(db, "products"), {
                                ...productData,
                                createdAt: new Date().toISOString()
                            });
                            alert("æ–°å¢æˆåŠŸï¼");
                            cancelEdit();
                        }
                    } catch (e) { alert("å¤±æ•— (æ¬Šé™ä¸è¶³): " + e.message); }
                };

                const deleteProduct = async (id) => {
                    if (!user.value) return alert("è«‹å…ˆç™»å…¥ï¼");
                    if (confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) await deleteDoc(doc(db, "products", id));
                };

                return {
                    products, layout, adminTab, form, layoutForm, 
                    ensureArray, saveProduct, deleteProduct, saveLayoutSettings, 
                    user, loginForm, login, logout, generateCaptcha,
                    openEdit, cancelEdit, isEditing
                };
            }
        }).mount('#app');
    </script>
</body>
</html>